# homework_en.py
# =================================================================
# Chapter 7: é€²éšæŒ‘æˆ°é¡Œ - API çµ„åˆæ¸¬è©¦çŸ©é™£ï¼ˆå¯¦å‹™ç´šï¼‰
# 
# å°ˆæ¡ˆç›®æ¨™ï¼š
# 1. æ¨¡æ“¬å¤šä½¿ç”¨è€… (Multi-user) ä½µç™¼å­˜å–å¤šå€‹ API ç«¯é» (Endpoints) çš„æ¸¬è©¦å ´æ™¯ã€‚
# 2. å¯¦ä½œã€Œå‹•æ…‹é‡è©¦æ©Ÿåˆ¶ã€ï¼šæ ¹æ“šä½¿ç”¨è€…è¦æ¨¡è‡ªå‹•èª¿æ•´æ¯å€‹è«‹æ±‚çš„æœ€å¤§é‡è©¦æ¬¡æ•¸ã€‚
# 3. å¯¦ä½œã€Œæ—©åœé‚è¼¯ (Early Exit)ã€ï¼šä»»ä¸€ API å¤±æ•—å³æ¨™è¨˜è©²ä½¿ç”¨è€…æ¸¬è©¦æœªé€šéã€‚
# 4. ç”¢å‡ºåˆ†é¡çµ±è¨ˆå ±è¡¨ï¼Œæ¸…æ™°å‘ˆç¾ã€Œé€šéã€èˆ‡ã€Œæœªé€šéã€çš„ä½¿ç”¨è€…åå–®ã€‚
# =================================================================


from api_random import mock_api_request

def main():
    # 1. åˆå§‹åŒ–æ¸¬è©¦è³‡æ–™
    users = ["Tom", "Jerry", "Chris", "Mabelle"]
    endpoints = ["/profile", "/orders", "/history"]
    
    # é—œéµï¼šæ ¹æ“šä½¿ç”¨è€…äººæ•¸è¨­å®šæ¯å€‹ç«¯é»çš„æœ€å¤§é‡è©¦æ¬¡æ•¸ (ç›®å‰ç‚º 4 æ¬¡)
    max_retries = len(users)

    # ç´€éŒ„æœ€çµ‚åˆ†é¡çµæœ
    passed_users = []
    failed_users = []

    print(f"ğŸš€ é–‹å§‹åŸ·è¡Œ API çµ„åˆæ¸¬è©¦çŸ©é™£ (æ¯å€‹ç«¯é»æœ€å¤§é‡è©¦æ¬¡æ•¸: {max_retries})...\n")

    # å¤–å±¤è¿´åœˆï¼šéæ­·æ¯ä¸€ä½ä½¿ç”¨è€…
    for name in users:
        is_user_all_passed = True  # åˆå§‹å‡è¨­è©²ä½¿ç”¨è€…æ‰€æœ‰æ¸¬è©¦éƒ½æœƒé€šé

        # ä¸­å±¤è¿´åœˆï¼šæ¸¬è©¦è©²ä½¿ç”¨è€…çš„æ¯ä¸€å€‹ API ç«¯é»
        for ep in endpoints:
            success = False
            
            # å…§å±¤è¿´åœˆï¼šé‡å°å–®ä¸€ç«¯é»é€²è¡Œå‹•æ…‹æ¬¡æ•¸çš„é‡è©¦
            # ä½¿ç”¨ range(max_retries) ä»£è¡¨æœƒè·‘ 0, 1, 2, 3 å…± 4 æ¬¡
            for attempt in range(max_retries):
                status = mock_api_request()
                if status == "200 OK":
                    success = True
                    break  # åªè¦æˆåŠŸä¸€æ¬¡ï¼Œå°±è·³å‡ºé‡è©¦è¿´åœˆ
            
            # åˆ¤å®šè©²ç«¯é»æœ€çµ‚çµæœä¸¦å°å‡ºè©³ç´°æ—¥èªŒ
            if success:
                print(f"  [PASS] {name} -> {ep}")
            else:
                print(f"  [FAIL] {name} -> {ep} (é‡è©¦ {max_retries} æ¬¡å¾Œä»å¤±æ•—)")
                is_user_all_passed = False  # åªè¦æœ‰ä¸€å€‹ç«¯é»å¤±æ•—ï¼Œæ¨™è¨˜è©²ä½¿ç”¨è€…ç‚ºå¤±æ•—
                break  # å¯¦å‹™å„ªåŒ–ï¼šä»»ä¸€ API å¤±æ•—å¾Œï¼Œè©²ä½¿ç”¨è€…å¾ŒçºŒç«¯é»å°±ä¸å¿…å†æ¸¬ï¼Œç›´æ¥è·³å‡º

        # 2. æ ¹æ“šæ¨™èªŒä½å°‡ä½¿ç”¨è€…åŠ å…¥å°æ‡‰æ¸…å–®
        if is_user_all_passed:
            passed_users.append(name)
        else:
            failed_users.append(name)

    # 3. è¼¸å‡ºç¬¦åˆé¡Œç›®è¦æ±‚çš„æ ¼å¼åŒ–å ±è¡¨
    print("\nğŸ“Š æ¸¬è©¦çµæœå ±å‘Š")
    print("-" * 25)
    
    # ä½¿ç”¨è¿´åœˆå°å‡ºé€šéåå–®
    for name in passed_users:
        print(f"âœ… é€šéï¼š{name}")
        
    # ä½¿ç”¨è¿´åœˆå°å‡ºæœªé€šéåå–®
    for name in failed_users:
        print(f"âŒ æœªé€šéï¼š{name}")

if __name__ == "__main__":
    main()